<Biml xmlns="http://schemas.varigence.com/biml.xsd">
  <Connections>
    <OleDbConnection Name="MD" ConnectionString="{{ Connections.Metadata.ConnectionString }} " CreateInProject="true" />
    <OleDbConnection Name="HLP_LOCAL" ConnectionString="{{ Connections.Helpers[0].ConnectionString }} " CreateInProject="false">
      <Expressions>
        <Expression PropertyName="ConnectionString">
          @[User::HelperConnectionString]
        </Expression>
      </Expressions>
    </OleDbConnection>
    <OleDbConnection Name="STG" ConnectionString="{{ Connections.Staging.ConnectionString }} " CreateInProject="true" />
    <OleDbConnection Name="LOG" ConnectionString="{{ Connections.Log.ConnectionString }} " CreateInProject="true" />
    <OleDbConnection Name="CFG" ConnectionString="{{ Connections.Configuration.ConnectionString }}" CreateInProject="true" />
  </Connections>  
  <Packages>
    <Package Name="Load_STG_{{ Object.DestinationTable.Name }}" ConstraintMode="Parallel" ProtectionLevel="EncryptSensitiveWithUserKey" DelayValidation="true"> 
      <Annotations>
        <Annotation AnnotationType="Description">
          <![CDATA[ 
               SolidQ Adaptive BI Framework 3.0

	            Template: 
		            Name: Full Loop
                Source: View
		            Authors: dmauri, megea
		            Revision: 2.2
	
	            Required:
		            MetadataVersion: 1

	            Compilation:
		            Date: {{ ABI.Compiler.CompilationDateTime }}
          ]]>
        </Annotation>
      </Annotations>
      <Variables>
        <Variable Name="LoadedRows" DataType="Int32" Namespace="User">0</Variable>
        <Variable Name="IsActive" DataType="String" Namespace="User">N</Variable>
        <Variable Name="LogRowId" DataType="Int32" Namespace="User">0</Variable>
        <Variable Name="ExtractTag" DataType="Int32" Namespace="User">0</Variable>
        <Variable Name="ResultSet" DataType="Object" Namespace="User"></Variable>        
        <Variable Name="HelperConnectionString" DataType="String" Namespace="User">{{ Connections.Helpers[0].ConnectionString }}</Variable>
      </Variables>
      <Tasks>
        <ExecuteSQL Name="Check Load Active" ConnectionName="CFG" ResultSet="SingleRow">
          <DirectInput>SELECT active_for_load AS active FROM cfg.[extract_phase] WHERE source_object_name = '{{ Object.SourceObject.FullName }}';</DirectInput>
          <Results>
            <Result Name="active" VariableName="User.IsActive"/>
          </Results>
        </ExecuteSQL>
        <ExecuteSQL Name="Set Load Start" ConnectionName="LOG" ResultSet="SingleRow">
          <PrecedenceConstraints>
            <Inputs>
              <Input OutputPathName="Check Load Active.Output" EvaluationOperation="ExpressionAndConstraint" EvaluationValue="Success" Expression='@[User::IsActive] == "Y"'/>
            </Inputs>
          </PrecedenceConstraints>
          <DirectInput>
            DECLARE @rowId INT;
            EXEC @rowId = [log].stp_etl_table_load_info_set_start 'stg', '{{ Object.DestinationTable.FullName }}', 'F', ?;
            SELECT CAST(@rowId AS INT) AS RowId
          </DirectInput>
          <Parameters>
            <Parameter Name="@serverExecutionId" VariableName="System.ServerExecutionID" DataType="Int64" Direction="Input"/>
          </Parameters>
          <Results>
            <Result Name="RowId" VariableName="User.LogRowId" />
          </Results>
        </ExecuteSQL>
        <ExecuteSQL Name="Load Connections Info" ConnectionName="MD" ResultSet="Full">
          <PrecedenceConstraints>
            <Inputs>
              <Input OutputPathName="Set Load Start.Output" EvaluationOperation="Constraint" EvaluationValue="Success"/>
            </Inputs>
          </PrecedenceConstraints>
          <DirectInput>
            SELECT c.[connection_string], e.[extract_tag] FROM md.[extract_phase_info_connections] e
            INNER JOIN md.[etl_connections] c ON e.[etl_connection_id] = c.[etl_connection_id]
            WHERE [source_object_name] = '{{ Object.SourceObject.FullName }}'
          </DirectInput>
          <Results>
            <Result Name="0" VariableName="User.ResultSet" />
          </Results>
        </ExecuteSQL>
        <ExecuteSQL Name="Clean Staging Table" ConnectionName="STG">
          <PrecedenceConstraints>
            <Inputs>
              <Input OutputPathName="Load Connections Info.Output" EvaluationOperation="Constraint" EvaluationValue="Success"/>
            </Inputs>
          </PrecedenceConstraints>
          <DirectInput>TRUNCATE TABLE  {{ Object.DestinationTable.FullName }};</DirectInput>
        </ExecuteSQL>
        <ForEachAdoLoop EnumerationMode="EnumerateRowsInFirstTable" ConstraintMode="Linear" Name="Load Data" SourceVariableName="User.ResultSet">
          <PrecedenceConstraints>
            <Inputs>
              <Input OutputPathName="Clean Staging Table.Output" EvaluationOperation="Constraint" EvaluationValue="Success"/>
            </Inputs>
          </PrecedenceConstraints>
          <Variables>
            <Variable Name="ConnectionString" DataType="String" Namespace="User"></Variable>
          </Variables>
          <VariableMappings>
            <VariableMapping Name="0" VariableName="User.HelperConnectionString" />
            <VariableMapping Name="1" VariableName="User.ExtractTag" />
          </VariableMappings>
          <Tasks>
            <Dataflow Name="Load Staging Table">
              <Transformations>
                <OleDbSource Name="HLP" ConnectionName="HLP_LOCAL">
                  <DirectInput>SELECT * FROM {{ Object.SourceObject.FullName }} OPTION (RECOMPILE);</DirectInput>
                </OleDbSource>
                <DerivedColumns Name="Add Metadata">
                  <InputPath OutputPathName="HLP.Output"/>
                  <Columns>
                    <Column Name="$sq_log_id" DataType="Int32">@LogRowId</Column>
                    <Column Name="$sq_extract_tag" DataType="Int32">@ExtractTag</Column>
                  </Columns>
                </DerivedColumns>
                <RowCount Name="Count Rows" VariableName="User.LoadedRows">
                  <InputPath OutputPathName="Add Metadata.Output" />
                </RowCount>
                <OleDbDestination Name="STG" ConnectionName="STG" UseFastLoadIfAvailable="true">
                  <InputPath OutputPathName="Count Rows.Output" />
                  <ExternalTableOutput Table="{{ Object.DestinationTable.FullName }}" />
                </OleDbDestination>
              </Transformations>
            </Dataflow>
          </Tasks>
        </ForEachAdoLoop>       
        <ExecuteSQL Name="Set Load End Success" ConnectionName="LOG">
          <PrecedenceConstraints>
            <Inputs>
              <Input OutputPathName="Load Data.Output" EvaluationOperation="Constraint" EvaluationValue="Success"/>
            </Inputs>
          </PrecedenceConstraints>
          <DirectInput>EXEC [log].stp_etl_table_load_info_set_end ?, ?, 'S';</DirectInput>
          <Parameters>
            <Parameter Name="@rowId" VariableName="User.LogRowId" DataType="Int32" Direction="Input" />
            <Parameter Name="@rows" VariableName="User.LoadedRows" DataType="Int32" Direction="Input" />
          </Parameters>
        </ExecuteSQL>
        <ExecuteSQL Name="Set Load End Failure" ConnectionName="LOG">
          <PrecedenceConstraints>
            <Inputs>
              <Input OutputPathName="Load Data.Output" EvaluationOperation="Constraint" EvaluationValue="Failure"/>
            </Inputs>
          </PrecedenceConstraints>
          <DirectInput>EXEC [log].stp_etl_table_load_info_set_end ?, ?, 'F';</DirectInput>
          <Parameters>
            <Parameter Name="@rowId" VariableName="User.LogRowId" DataType="Int32" Direction="Input" />
            <Parameter Name="@rows" VariableName="User.LoadedRows" DataType="Int32" Direction="Input" />
          </Parameters>
        </ExecuteSQL>
      </Tasks>
    </Package>
  </Packages>
</Biml>